name: windows-build

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-multimedia
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-opus
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-ffmpeg
            mingw-w64-x86_64-x264

      - name: Configure
        run: >
          cmake -S . -B build-win
          -G Ninja
          -DCMAKE_BUILD_TYPE=Release
          -DP2PCHAT_ENABLE_VIDEO=ON
          -DP2PCHAT_ENABLE_VOICE=ON

      - name: Build
        run: cmake --build build-win -j 2

      - name: Verify video linkage
        run: |
          set -euo pipefail
          objdump -p build-win/p2p_chat_gui.exe | grep -Ei "DLL Name: .*avcodec" >/dev/null
          objdump -p build-win/p2p_chat_gui.exe | grep -Ei "DLL Name: .*avutil" >/dev/null
          objdump -p build-win/p2p_chat_gui.exe | grep -Ei "DLL Name: .*swscale" >/dev/null

      - name: Bundle
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          cp build-win/p2p_chat_gui.exe dist/

          # Deploy Qt runtime.
          windeployqt --release --no-translations --compiler-runtime dist/p2p_chat_gui.exe

          # Copy all transitive DLL deps from /mingw64/bin into dist/.
          # This prevents "missing libpng/libicu/libdoubleconversion/..." at runtime.
          declare -A seen
          queue=()
          while IFS= read -r f; do
            queue+=("$f")
          done < <(find dist -type f \( -iname "*.exe" -o -iname "*.dll" \))

          deps_of() {
            objdump -p "$1" 2>/dev/null | awk '/DLL Name:/ {print $3}'
          }

          is_system_dll() {
            case "$1" in
              KERNEL32.dll|USER32.dll|GDI32.dll|ADVAPI32.dll|SHELL32.dll|OLE32.dll|OLEAUT32.dll|COMDLG32.dll|COMCTL32.dll|WS2_32.dll|IPHLPAPI.dll|DNSAPI.dll|WINMM.dll|VERSION.dll|IMM32.dll|MSVCRT.dll|SHLWAPI.dll|DWMAPI.dll|UXTHEME.dll|WINSPOOL.DRV|WININET.dll|CRYPT32.dll|SECUR32.dll|NTDLL.dll|SETUPAPI.dll|BCRYPT.dll|BCRYPTPRIMITIVES.dll|dbghelp.dll)
                return 0
                ;;
            esac
            return 1
          }

          idx=0
          while [ $idx -lt ${#queue[@]} ]; do
            f="${queue[$idx]}"
            idx=$((idx+1))
            [ -f "$f" ] || continue
            while IFS= read -r dep; do
              [ -n "$dep" ] || continue
              # Normalize to the canonical filename casing used on disk.
              dep_file="$(basename "$dep")"
              if is_system_dll "$dep_file"; then
                continue
              fi
              if [ "${seen[$dep_file]+x}" = "x" ]; then
                continue
              fi
              seen[$dep_file]=1

              if [ -f "dist/$dep_file" ]; then
                queue+=("dist/$dep_file")
                continue
              fi
              if [ -f "/mingw64/bin/$dep_file" ]; then
                cp "/mingw64/bin/$dep_file" dist/
                queue+=("dist/$dep_file")
              fi
            done < <(deps_of "$f")
          done

      - uses: actions/upload-artifact@v4
        with:
          name: p2p_chat_gui-windows
          # Upload the folder directly; GitHub will produce a standard ZIP for download.
          # This avoids nested ZIPs and any unzip tool confusion about encryption.
          path: dist/**
